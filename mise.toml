# Open Notes Multi-Service Project Configuration
# ==============================================
#
# Task Naming Convention: verb:noun:object:environment
#   - build:containers:server     (build container for server)
#   - build:types:openapi         (build OpenAPI types)
#   - test:server                 (run server tests)
#   - lint:discord                (run discord linter)
#   - db:migrate                  (run database migrations)
#   - validate:api                (validate API endpoints)
#
# For specific test/lint options, use -- to pass args:
#   - mise run test:server -- -k test_auth
#   - mise run lint:server -- --fix
#
# See: mise tasks

[tools]
python = "3.11"
uv = "latest"
node = "20"
pnpm = "latest"
yq = "latest"

[env]
IMAGE_TAG = "latest"
_.file = ".env.yaml"

[vars]
server_dir = "opennotes-server"
discord_dir = "opennotes-discord"

# ========================================
# Internal Helper Tasks
# ========================================

[tasks."_env:convert"]
description = "Convert .env.yaml files to .env format for docker-compose"
run = '''
# Convert main .env.yaml for docker-compose
if [ -f ".env.yaml" ]; then
    echo "Converting .env.yaml -> .env"
    yq eval -o=shell '.' ".env.yaml" > ".env"
fi

# Convert service-specific .env.yaml files
for yaml_file in opennotes-*/.env.yaml; do
    if [ -f "$yaml_file" ]; then
        env_file="${yaml_file%.yaml}"
        echo "Converting $yaml_file -> $env_file"
        yq eval -o=shell '.' "$yaml_file" > "$env_file"
    fi
done
'''

[tasks."_env:cleanup"]
description = "Remove generated .env files (keep .env.yaml as source of truth)"
run = '''
rm -f .env
find opennotes-* -name ".env" -not -name "*.yaml" -type f -delete
echo "Cleaned up generated .env files"
'''

[tasks."_db:get-prefix"]
description = "Internal: Detect environment and output command prefix for database operations"
dir = "{{vars.server_dir}}"
run = '''
# Check if opennotes-server container is running
if docker ps -q -f name=opennotes-server | grep -q .; then
    echo "Running inside opennotes-server container..." >&2
    echo "docker exec opennotes-server "
else
    echo "Running on host..." >&2
    # Check if database is accessible before proceeding
    if [ -z "${DATABASE_URL:-}" ]; then
        echo "DATABASE_URL not set. Cannot run database operations on host." >&2
        echo "   Either:" >&2
        echo "   1. Start containers: mise run dev:up" >&2
        echo "   2. Set DATABASE_URL environment variable" >&2
        exit 1
    fi
    echo ""
fi
'''

# ========================================
# Development Tasks
# ========================================

[tasks.install]
description = "Install project dependencies"
run = [
    "cd {{vars.server_dir}} && uv venv && uv pip install -e '.[dev]'",
    "cd {{vars.discord_dir}} && pnpm install"
]

[tasks.dev]
description = "Start development environment and generate types"
run = '''
# Generate OpenAPI spec and TypeScript types
echo "Generating OpenAPI spec and TypeScript types..."
cd {{vars.server_dir}} && uv run python scripts/generate-openapi.py --output openapi.json
cd ../{{vars.discord_dir}} && pnpm types:generate

echo ""
echo "Development environment ready!"
echo "   Server: http://localhost:8000"
echo "   Discord: http://localhost:3000"
'''

# ========================================
# Testing Tasks
# ========================================

[tasks.test]
description = "Run all tests"
depends = ["test:server", "test:discord"]

[tasks."test:server"]
description = "Run server tests (pass options via --)"
dir = "{{vars.server_dir}}"
run = 'uv run pytest -v "$@"'
sources = ["src/**/*.py", "tests/**/*.py"]
env = { PYTHONPATH = "." }

[tasks."test:discord"]
description = "Run Discord bot tests (pass options via --)"
dir = "{{vars.discord_dir}}"
run = "pnpm test \"$@\""
sources = ["src/**/*.ts", "tests/**/*.ts"]

# ========================================
# Linting Tasks
# ========================================

[tasks.lint]
description = "Run all linters"
depends = ["lint:server", "lint:discord"]

[tasks."lint:server"]
description = "Run Python linters (use -- --fix to auto-fix)"
dir = "{{vars.server_dir}}"
run = '''
# Check if --fix was passed
if [[ " $* " == *" --fix "* ]]; then
    echo "Fixing Python linting issues..."
    uv run ruff format src tests
    uv run ruff check --fix src tests
else
    uv run ruff format --check src tests
    uv run ruff check src tests
    uv run basedpyright src
fi
'''

[tasks."lint:discord"]
description = "Run TypeScript linters (use -- --fix to auto-fix)"
dir = "{{vars.discord_dir}}"
run = '''
# Check if --fix was passed
if [[ " $* " == *" --fix "* ]]; then
    pnpm run lint:fix
else
    pnpm run lint
fi
'''

# ========================================
# Database Tasks
# ========================================

[tasks."db:migrate"]
description = "Run database migrations (container-aware)"
dir = "{{vars.server_dir}}"
run = '''
DB_OPS_CMD_PREFIX="$(mise run _db:get-prefix)"
${DB_OPS_CMD_PREFIX}uv run alembic upgrade head
'''
alias = "migrate"

[tasks."db:migrate:create"]
description = "Create new migration (container-aware)"
dir = "{{vars.server_dir}}"
run = '''
MESSAGE="{{arg(name="message")}}"
DB_OPS_CMD_PREFIX="$(mise run _db:get-prefix)"
${DB_OPS_CMD_PREFIX}uv run alembic revision --autogenerate -m "$MESSAGE"
'''
usage = '''
arg "message" description="Migration message" default="auto migration"
'''

[tasks."db:migrate:history"]
description = "Show migration history (container-aware)"
dir = "{{vars.server_dir}}"
run = '''
DB_OPS_CMD_PREFIX="$(mise run _db:get-prefix)"
${DB_OPS_CMD_PREFIX}uv run alembic history
'''

[tasks."db:shell"]
description = "Open database shell"
run = "docker exec -it opennotes-postgres psql -U opennotes -d opennotes"

[tasks."db:check"]
description = "Check for schema drift between models and database (container-aware)"
dir = "{{vars.server_dir}}"
run = '''
DB_OPS_CMD_PREFIX="$(mise run _db:get-prefix)"
${DB_OPS_CMD_PREFIX}uv run alembic check
'''
alias = "check-schema"

[tasks."redis:cli"]
description = "Open Redis CLI"
run = "docker exec -it opennotes-redis redis-cli"

# ========================================
# Build Tasks
# ========================================

[tasks."build:containers:all"]
description = "Build all Docker images"
depends = ["_env:convert"]
run = "docker-compose -f docker-compose.yml -f docker-compose.prod.yml build"
alias = "build"

[tasks."build:containers:server"]
description = "Build opennotes-server image"
dir = "{{vars.server_dir}}"
run = "docker build -t opennotes-server:{{env.IMAGE_TAG}} ."

[tasks."build:containers:discord"]
description = "Build opennotes-discord image"
dir = "{{vars.discord_dir}}"
run = "docker build -t opennotes-discord:{{env.IMAGE_TAG}} ."

[tasks."build:types:openapi"]
description = "Generate OpenAPI specification and TypeScript types"
dir = "{{vars.server_dir}}"
run = '''
echo "Generating OpenAPI specification..."
uv run python scripts/generate-openapi.py --output openapi.json

echo "Regenerating TypeScript types for Discord bot..."
cd ../{{vars.discord_dir}} && pnpm types:generate

echo "OpenAPI spec and TypeScript types updated!"
'''

# ========================================
# Validation Tasks
# ========================================

[tasks."validate:api"]
description = "Validate Discord bot endpoints against OpenAPI spec"
depends = ["build:types:openapi"]
run = "python3 opennotes/scripts/validate-api-endpoints.py"
alias = "validate-api"

# ========================================
# Task Configuration
# ========================================

[task_config]
# Run tasks from the project root by default
dir = "{{cwd}}"

# Include additional task files if they exist
includes = [
    ".mise.local.toml",  # Local overrides (git ignored)
    "tasks/"             # Directory with additional task files
]
