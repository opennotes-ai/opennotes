# Open Notes Environment Configuration
#
# This is the master environment configuration template for all Open Notes services.
# Copy this file to .env or .env.local and update with your actual values.
#
# File locations:
#   - opennotes/.env.yaml.example  - This template (committed to git)
#   - opennotes/.env.yaml          - Your environment config (gitignored, used by services)
#   - opennotes/.env.local         - Local developer overrides (gitignored, highest priority)
#
# Local Development Environment:
#   - Uses OpenTofu (infrastructure/environments/local/) to manage containers
#   - Services launched via: mise run dev
#   - Docker Compose files in opennotes/ are used ONLY by testcontainers for testing
#
# Quick Start:
#   1. Copy this file: cp .env.yaml.example .env.yaml
#   2. Generate JWT secret: openssl rand -hex 32
#   3. Add your Discord bot credentials (from Discord Developer Portal)
#   4. Update passwords and secrets
#   5. Start services: mise run dev

# ============================================================================
# CORE ENVIRONMENT
# ============================================================================

# Environment type: development, staging, production, test
ENVIRONMENT: development

# Service selection for mise tasks: all, server, discord
SERVICE: all

# Enable debug mode (development only)
DEBUG: true

# Logging level: debug, info, warning, error, critical
LOG_LEVEL: info

# ============================================================================
# DATABASE - PostgreSQL
# ============================================================================

# Database connection details
POSTGRES_DB: opennotes
POSTGRES_USER: opennotes
POSTGRES_PASSWORD: opennotes_dev_password
# CHANGE IN PRODUCTION!

# Port exposure (optional, defaults in OpenTofu)
# POSTGRES_PORT: 5432

# Full database URL (auto-constructed if not provided)
# Format: postgresql+asyncpg://user:password@host:port/database
# Default: Uses POSTGRES_* variables above with host from Docker network
DATABASE_URL: "postgresql+asyncpg://opennotes:opennotes_dev_password@postgres:5432/opennotes"

# ============================================================================
# CACHE - Redis
# ============================================================================

# Redis connection URL
REDIS_URL: "redis://redis:6379/0"
REDIS_DB: 0

# Port exposure (optional, defaults in OpenTofu)
# REDIS_PORT: 6379

# Redis connection pool settings
REDIS_MAX_CONNECTIONS: 10
REDIS_SOCKET_TIMEOUT: 5
REDIS_SOCKET_CONNECT_TIMEOUT: 5
REDIS_RETRY_ON_TIMEOUT: true

# Cache TTL settings (seconds)
CACHE_SCORING_TTL: 300
# 5 minutes
CACHE_USER_PROFILE_TTL: 3600
# 1 hour
CACHE_DEFAULT_TTL: 600
# 10 minutes

# Session settings (seconds)
SESSION_TTL: 86400
# 24 hours
SESSION_REFRESH_TTL: 604800
# 7 days

# ============================================================================
# MESSAGE BROKER - NATS JetStream
# ============================================================================

# NATS connection URL
NATS_URL: "nats://nats:4222"

# Port exposure (optional, defaults in OpenTofu)
# NATS_CLIENT_PORT: 4222
# NATS_HTTP_PORT: 8222

# NATS connection settings
NATS_MAX_RECONNECT_ATTEMPTS: 10
NATS_RECONNECT_WAIT: 2

# NATS stream configuration
NATS_STREAM_NAME: OPENNOTES
NATS_CONSUMER_NAME: opennotes-server

# ============================================================================
# BACKEND SERVER - Open Notes FastAPI
# ============================================================================

# Server configuration
SERVER_HOST: 0.0.0.0
SERVER_PORT: 8000
OPENNOTES_SERVICE_URL: "http://opennotes-server:8000"

# Port exposure (optional, defaults in OpenTofu)
# SERVER_PORT: 8000

# Project metadata
PROJECT_NAME: "Open Notes Server"
VERSION: 1.0.0

# CORS origins (comma-separated)
CORS_ORIGINS: "http://localhost:3000,http://localhost:5173,http://localhost:8000"

# Worker configuration
MAX_WORKERS: 2
# Development: 2, Production: 4
WORKER_ENABLED: true
SCORING_ENABLED: true

# ============================================================================
# EMBEDDING SERVICE - OpenAI Embeddings
# ============================================================================

# OpenAI embedding configuration
EMBEDDING_MODEL: text-embedding-3-small
# OpenAI embedding model (e.g., text-embedding-3-small, text-embedding-3-large)
EMBEDDING_DIMENSIONS: 1536
# Embedding vector dimensions (must match model: 1536 for small, 3072 for large)

# Embedding cache settings (seconds)
EMBEDDING_CACHE_TTL_SECONDS: 3600
# Cache TTL for embeddings (1 hour default)
EMBEDDING_CLIENT_CACHE_MAX_SIZE: 100
# Max OpenAI client cache size
EMBEDDING_CLIENT_CACHE_TTL_SECONDS: 3600
# Client cache TTL (1 hour default)

# ============================================================================
# DISCORD BOT - Open Notes Discord
# ============================================================================

# Discord API credentials (REQUIRED)
# Get these from: https://discord.com/developers/applications
DISCORD_TOKEN: your_discord_bot_token_here
DISCORD_CLIENT_ID: your_discord_client_id_here
# Public key must be exactly 64 hex characters (32 bytes)
DISCORD_PUBLIC_KEY: "0000000000000000000000000000000000000000000000000000000000000000"
DISCORD_APPLICATION_ID: your_discord_application_id_here

# Discord bot configuration
NODE_ENV: development
# development, production
PORT: 3000

# Port exposure (optional, defaults in OpenTofu)
# DISCORD_PORT: 3000

# ============================================================================
# SECURITY - Authentication & Authorization
# ============================================================================

# JWT Configuration (REQUIRED)
# Generate a secure key: openssl rand -hex 32
JWT_SECRET_KEY: change-this-secret-key-in-production-use-openssl-rand-hex-32
JWT_ALGORITHM: HS256
ACCESS_TOKEN_EXPIRE_MINUTES: 30
REFRESH_TOKEN_EXPIRE_DAYS: 7

# Rate limiting
RATE_LIMIT_ENABLED: true
RATE_LIMIT_PER_MINUTE: 60
WEBHOOK_RATE_LIMIT_PER_GUILD: 100
WEBHOOK_RATE_LIMIT_WINDOW: 60

# ============================================================================
# RESILIENCE - Circuit Breaker & Queue
# ============================================================================

# Circuit breaker configuration
CIRCUIT_BREAKER_FAILURE_THRESHOLD: 5
CIRCUIT_BREAKER_TIMEOUT: 60
CIRCUIT_BREAKER_EXPECTED_EXCEPTION: Exception

# Queue configuration
QUEUE_MAX_RETRIES: 3
QUEUE_RETRY_DELAY: 1
QUEUE_RETRY_BACKOFF: 2.0

# Interaction handling
INTERACTION_CACHE_TTL: 300
# 5 minutes
INTERACTION_RESPONSE_TIMEOUT: 3
# 3 seconds

# ============================================================================
# MONITORING & OBSERVABILITY
# ============================================================================

# Feature flags
ENABLE_METRICS: true
ENABLE_TRACING: true
ENABLE_JSON_LOGGING: true
ENABLE_CONSOLE_TRACING: false

# OpenTelemetry (optional)
# Points to Tempo in monitoring stack
OTLP_ENDPOINT: "http://tempo:4317"

# ============================================================================
# INFRASTRUCTURE & DEPLOYMENT
# ============================================================================

# Container image configuration
IMAGE_TAG: latest
REGISTRY: ghcr.io
IMAGE_REPO: opennotes-ai/multiverse

# OpenTofu configuration
# TOFU_VAR_monitoring_enabled: false  # Set to true to enable monitoring stack

# ============================================================================
# ENCRYPTION KEYS (REQUIRED)
# ============================================================================

# Fernet key for credential encryption
# Generate with: python -c 'from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())'
CREDENTIALS_ENCRYPTION_KEY: CHANGE_THIS_GENERATE_FERNET_KEY

# Master encryption key for LLM API keys (32 bytes, base64)
# Generate with: python -c 'import secrets, base64; print(base64.urlsafe_b64encode(secrets.token_bytes(32)).decode())'
ENCRYPTION_MASTER_KEY: CHANGE_THIS_GENERATE_32_BYTE_BASE64_KEY

# ============================================================================
# DEVELOPMENT TOOLS
# ============================================================================

# Testing mode flag
TESTING: 0

# Enable hot reload (development only)
# RELOAD: true  # Set by OpenTofu or local override

# ============================================================================
# GRAFANA (MONITORING STACK)
# ============================================================================

# Grafana admin credentials (optional, for monitoring stack)
GRAFANA_ADMIN_USER: admin
GRAFANA_ADMIN_PASSWORD: admin
GRAFANA_ROOT_URL: "http://localhost:3001"

# ============================================================================
# NOTES & BEST PRACTICES
# ============================================================================

# Security:
#   - NEVER commit .env files with real secrets
#   - Generate strong JWT_SECRET_KEY: openssl rand -hex 32
#   - Use strong database passwords in production
#   - Rotate secrets regularly
#
# Development:
#   - Copy .env.yaml.example to .env.yaml for local development
#   - Use .env.local for personal overrides (gitignored)
#   - OpenTofu (infrastructure/environments/local/) manages services
#   - Start with: mise run dev
#
# Testing:
#   - Tests use docker-compose.yml via testcontainers for isolated config
#   - Separate test database and ports (not for direct usage)
#   - Docker Compose automatically handled by test framework
#
# Production:
#   - Uses Kubernetes with kustomize (k8s/production/)
#   - Set DEBUG: false, LOG_LEVEL: info
#   - Uses sealed-secrets for credential storage
#   - Never use default passwords
#
# Staging:
#   - Mirror production config with test credentials
#   - Uses Kubernetes staging overlay (k8s/staging/)
