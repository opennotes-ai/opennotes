# Open Notes Discord Bot - mise configuration
#
# This is the Discord bot-specific configuration.
# Main tasks (test, build, deploy) are at the parent opennotes/ level.
# Use: cd opennotes && mise run test:discord

[tools]
node = "20"

[env]
_.file = ".env.yaml"
NODE_ENV = "development"

[vars]
src_dir = "src"

# ========================================
# Development Tasks
# ========================================

[tasks.install]
description = "Install Node.js dependencies"
run = "npm install"

[tasks.dev]
description = "Run development bot with hot reload"
run = "npm run dev"
env = { NODE_ENV = "development" }

[tasks.start]
description = "Start production bot"
run = "npm start"
env = { NODE_ENV = "production" }

[tasks.build]
description = "Build TypeScript to JavaScript"
run = "npm run build"
sources = ["{{vars.src_dir}}/**/*.ts", "tsconfig.json"]
outputs = ["dist/**/*.js"]

# ========================================
# Code Quality Tasks
# ========================================

[tasks.lint]
description = "Run ESLint"
run = "eslint {{vars.src_dir}} --ext .ts,.tsx"

[tasks."lint:fix"]
description = "Fix ESLint issues"
run = "eslint {{vars.src_dir}} --ext .ts,.tsx --fix"
alias = "fix"

[tasks.format]
description = "Format code with Prettier"
run = "prettier --write '{{vars.src_dir}}/**/*.{ts,tsx,json}'"

[tasks.typecheck]
description = "Run TypeScript type checking"
run = "tsc --noEmit"

# ========================================
# Discord Commands Management
# ========================================

[tasks."commands:register"]
description = "Register slash commands with Discord"
run = "node scripts/register-commands.js"
confirm = "Register commands to Discord API?"

[tasks."commands:delete"]
description = "Delete all registered commands"
run = "node scripts/delete-commands.js"
confirm = "Delete ALL commands from Discord?"

[tasks."commands:list"]
description = "List registered Discord commands"
run = "node scripts/list-commands.js"

# ========================================
# Utility Tasks
# ========================================

[tasks.clean]
description = "Clean generated files"
run = [
    "rm -rf dist node_modules coverage",
    "rm -rf .jest_cache .eslintcache"
]

[tasks.deps]
description = "Check dependencies"
run = "npm list --depth=0"

[tasks.outdated]
description = "Check for outdated packages"
run = "npm outdated"

[tasks.update]
description = "Update dependencies"
run = "npm update"

[tasks.audit]
description = "Run security audit"
run = "npm audit"

[tasks."audit:fix"]
description = "Fix security issues"
run = "npm audit fix"

# ========================================
# Pre-commit Hooks
# ========================================

[tasks."pre-commit"]
description = "Run pre-commit checks"
depends = ["lint", "typecheck"]
env = { PRE_COMMIT = "1" }
