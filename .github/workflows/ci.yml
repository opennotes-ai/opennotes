name: CI Pipeline

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'

jobs:
  detect-changes:
    name: Detect Changed Services
    runs-on: blacksmith-4vcpu-ubuntu-2404
    timeout-minutes: 15
    outputs:
      server: ${{ steps.filter.outputs.server }}
      discord: ${{ steps.filter.outputs.discord }}
      shared: ${{ steps.filter.outputs.shared }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            server:
              - 'opennotes-server/**'
              - 'communitynotes/**'
            discord:
              - 'opennotes-discord/**'
            shared:
              - '.github/workflows/**'
              - 'docker-compose*.yml'

  pre-commit:
    name: Pre-commit Hooks
    runs-on: blacksmith-4vcpu-ubuntu-2404
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v3

      - name: Install mise
        uses: jdx/mise-action@v3
        with:
          install: true

      - name: Load cached mise tools
        id: cached-mise-tools
        uses: actions/cache@v4
        with:
          path: ~/.local/share/mise/installs
          key: mise-${{ runner.os }}-${{ hashFiles('**/mise.toml', '**/.mise.toml') }}

      - name: Install OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.8.2

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: opennotes-discord/pnpm-lock.yaml

      - name: Setup CI environment
        run: |
          echo "Setting up CI environment from .env.ci.yaml..."
          cp .env.ci.yaml .env.yaml

      - name: Install Node dependencies
        working-directory: opennotes-discord
        run: pnpm install --frozen-lockfile

      - name: Load cached venv
        id: cached-uv-dependencies
        uses: actions/cache@v4
        with:
          path: opennotes-server/.venv
          key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/uv.lock') }}

      - name: Install Python dependencies
        working-directory: opennotes-server
        run: |
          uv venv
          uv pip install -e ".[dev]"

      - name: Run pre-commit
        uses: pre-commit/action@v3.0.1
        env:
          SKIP: schema-consistency

  lint-python:
    name: Lint Python (opennotes-server)
    needs: detect-changes
    if: needs.detect-changes.outputs.server == 'true' || needs.detect-changes.outputs.shared == 'true'
    runs-on: blacksmith-4vcpu-ubuntu-2404
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v3

      - name: Install mise
        uses: jdx/mise-action@v3
        with:
          install: true

      - name: Load cached mise tools
        id: cached-mise-tools
        uses: actions/cache@v4
        with:
          path: ~/.local/share/mise/installs
          key: mise-${{ runner.os }}-${{ hashFiles('**/mise.toml', '**/.mise.toml') }}

      - name: Setup CI environment
        run: |
          echo "Setting up CI environment from .env.ci.yaml..."
          cp .env.ci.yaml .env.yaml

      - name: Load cached venv
        id: cached-uv-dependencies
        uses: actions/cache@v4
        with:
          path: opennotes-server/.venv
          key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/uv.lock') }}

      - name: Install dependencies
        working-directory: opennotes-server
        run: |
          uv venv
          uv pip install -e ".[dev]"

      - name: Run ruff format check
        working-directory: opennotes-server
        run: uv run ruff format --check src tests

      - name: Run ruff check
        working-directory: opennotes-server
        run: uv run ruff check src tests

      - name: Run basedpyright type check
        working-directory: opennotes-server
        run: uv run basedpyright src

  lint-typescript:
    name: Lint TypeScript (opennotes-discord)
    needs: detect-changes
    if: needs.detect-changes.outputs.discord == 'true' || needs.detect-changes.outputs.shared == 'true'
    runs-on: blacksmith-4vcpu-ubuntu-2404
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: opennotes-discord/pnpm-lock.yaml

      - name: Install dependencies
        working-directory: opennotes-discord
        run: pnpm install --frozen-lockfile

      - name: Clean and build workspace packages
        working-directory: opennotes-discord
        run: |
          pnpm --filter './packages/**' run clean || true
          pnpm --filter './packages/**' run build

      - name: Run ESLint
        working-directory: opennotes-discord
        run: pnpm run lint

      - name: Run TypeScript compiler
        working-directory: opennotes-discord
        run: pnpm run type-check

  unit-tests-python:
    name: Unit Tests (opennotes-server)
    needs: detect-changes
    if: needs.detect-changes.outputs.server == 'true' || needs.detect-changes.outputs.shared == 'true'
    runs-on: blacksmith-4vcpu-ubuntu-2404
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v3

      - name: Install mise
        uses: jdx/mise-action@v3
        with:
          install: true

      - name: Load cached mise tools
        id: cached-mise-tools
        uses: actions/cache@v4
        with:
          path: ~/.local/share/mise/installs
          key: mise-${{ runner.os }}-${{ hashFiles('**/mise.toml', '**/.mise.toml') }}

      - name: Setup CI environment
        run: |
          echo "Setting up CI environment from .env.ci.yaml..."
          cp .env.ci.yaml .env.yaml

      - name: Load cached venv
        id: cached-uv-dependencies
        uses: actions/cache@v4
        with:
          path: opennotes-server/.venv
          key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/uv.lock') }}

      - name: Install dependencies
        working-directory: opennotes-server
        run: |
          uv venv
          uv pip install -e ".[dev]"

      - name: Run unit tests with coverage
        env:
          JWT_SECRET_KEY: dGVzdC1qd3Qtc2VjcmV0LWtleS1mb3ItY2ktdGVzdGluZy1vbmx5LWRvLW5vdC11c2UtaW4tcHJvZHVjdGlvbg==
          CREDENTIALS_ENCRYPTION_KEY: cXRS8fmiHqGBVHwrX_9J7D4tHp_ZpFTMr3_XjP7kF1Y=
          ENCRYPTION_MASTER_KEY: R3pKvHGkdPxBc6FZ4N8qYmV2sJwLxTnC9A7M5E1bUh0=
        run: mise run test:server -- tests/unit/

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: opennotes-server/coverage.xml
          flags: server-unit
          name: opennotes-server-unit

  integration-tests-python:
    name: Integration Tests (opennotes-server)
    needs: [detect-changes]
    if: needs.detect-changes.outputs.server == 'true' || needs.detect-changes.outputs.shared == 'true'
    runs-on: blacksmith-4vcpu-ubuntu-2404
    timeout-minutes: 20
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v3

      - name: Install mise
        uses: jdx/mise-action@v3
        with:
          install: true

      - name: Load cached mise tools
        id: cached-mise-tools
        uses: actions/cache@v4
        with:
          path: ~/.local/share/mise/installs
          key: mise-${{ runner.os }}-${{ hashFiles('**/mise.toml', '**/.mise.toml') }}

      - name: Setup CI environment
        run: |
          echo "Setting up CI environment from .env.ci.yaml..."
          cp .env.ci.yaml .env.yaml

      - name: Load cached venv
        id: cached-uv-dependencies
        uses: actions/cache@v4
        with:
          path: opennotes-server/.venv
          key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/uv.lock') }}

      - name: Install dependencies
        working-directory: opennotes-server
        run: |
          uv venv
          uv pip install -e ".[dev]"

      - name: Build PostgreSQL with pgvector and pgroonga
        run: |
          docker build -t opennotes/postgres:18-pgvector-pgroonga docker/postgres
          echo "PostgreSQL image built with pgvector and pgroonga extensions"

      - name: Start PostgreSQL with pgvector and pgroonga
        run: |
          docker run -d --name postgres \
            -e POSTGRES_USER=opennotes \
            -e POSTGRES_PASSWORD=opennotes_password \
            -e POSTGRES_DB=opennotes_test \
            -p 5432:5432 \
            opennotes/postgres:18-pgvector-pgroonga
          # Wait for PostgreSQL to be ready
          timeout 60 bash -c 'until docker exec postgres pg_isready -U opennotes 2>/dev/null; do sleep 1; done'
          echo "PostgreSQL with pgvector and pgroonga is ready"

      - name: Start NATS with JetStream
        run: |
          docker run -d --name nats \
            -p 4222:4222 -p 8222:8222 \
            nats:2.10-alpine \
            --jetstream --http_port=8222
          # Wait for NATS to be ready
          timeout 30 bash -c 'until wget -q --spider http://localhost:8222/healthz 2>/dev/null; do sleep 1; done'
          echo "NATS with JetStream is ready"

      - name: Run integration tests with coverage
        env:
          DATABASE_URL: postgresql+asyncpg://opennotes:opennotes_password@localhost:5432/opennotes_test
          REDIS_URL: redis://localhost:6379/0
          NATS_URL: nats://localhost:4222
          SKIP_TESTCONTAINERS: "1"
        run: mise run test:server -- tests/integration/ -n 0

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: opennotes-server/coverage.xml
          flags: server-integration
          name: opennotes-server-integration

  validate-schema:
    name: Validate Database Schema
    needs: detect-changes
    if: needs.detect-changes.outputs.server == 'true' || needs.detect-changes.outputs.shared == 'true'
    runs-on: blacksmith-4vcpu-ubuntu-2404
    timeout-minutes: 20

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v3

      - name: Install mise
        uses: jdx/mise-action@v3
        with:
          install: true

      - name: Load cached mise tools
        id: cached-mise-tools
        uses: actions/cache@v4
        with:
          path: ~/.local/share/mise/installs
          key: mise-${{ runner.os }}-${{ hashFiles('**/mise.toml', '**/.mise.toml') }}

      - name: Setup CI environment
        run: |
          echo "Setting up CI environment from .env.ci.yaml..."
          cp .env.ci.yaml .env.yaml

      - name: Load cached venv
        id: cached-uv-dependencies
        uses: actions/cache@v4
        with:
          path: opennotes-server/.venv
          key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/uv.lock') }}

      - name: Install dependencies
        working-directory: opennotes-server
        run: |
          uv venv
          uv pip install -e ".[dev]"

      - name: Build PostgreSQL with pgvector and pgroonga
        run: |
          docker build -t opennotes/postgres:18-pgvector-pgroonga docker/postgres
          echo "PostgreSQL image built with pgvector and pgroonga extensions"

      - name: Start PostgreSQL with pgvector and pgroonga
        run: |
          docker run -d --name postgres \
            -e POSTGRES_USER=opennotes \
            -e POSTGRES_PASSWORD=opennotes_password \
            -e POSTGRES_DB=opennotes_test \
            -p 5432:5432 \
            opennotes/postgres:18-pgvector-pgroonga
          # Wait for PostgreSQL to be ready
          timeout 60 bash -c 'until docker exec postgres pg_isready -U opennotes 2>/dev/null; do sleep 1; done'
          echo "PostgreSQL with pgvector and pgroonga is ready"

      - name: Run database migrations
        env:
          DATABASE_URL: postgresql+asyncpg://opennotes:opennotes_password@localhost:5432/opennotes_test
          JWT_SECRET_KEY: dGVzdC1qd3Qtc2VjcmV0LWtleS1mb3ItY2ktdGVzdGluZy1vbmx5LWRvLW5vdC11c2UtaW4tcHJvZHVjdGlvbg==
          CREDENTIALS_ENCRYPTION_KEY: cXRS8fmiHqGBVHwrX_9J7D4tHp_ZpFTMr3_XjP7kF1Y=
          ENCRYPTION_MASTER_KEY: R3pKvHGkdPxBc6FZ4N8qYmV2sJwLxTnC9A7M5E1bUh0=
        run: mise run db:migrate

      - name: Check for schema drift
        env:
          DATABASE_URL: postgresql+asyncpg://opennotes:opennotes_password@localhost:5432/opennotes_test
          JWT_SECRET_KEY: dGVzdC1qd3Qtc2VjcmV0LWtleS1mb3ItY2ktdGVzdGluZy1vbmx5LWRvLW5vdC11c2UtaW4tcHJvZHVjdGlvbg==
          CREDENTIALS_ENCRYPTION_KEY: cXRS8fmiHqGBVHwrX_9J7D4tHp_ZpFTMr3_XjP7kF1Y=
          ENCRYPTION_MASTER_KEY: R3pKvHGkdPxBc6FZ4N8qYmV2sJwLxTnC9A7M5E1bUh0=
        run: |
          echo "Checking for schema drift between models and database..."
          mise run db:check
          echo "✅ No schema drift detected - models and database are in sync"

  validate-schema-consistency:
    name: Validate Schema Consistency
    needs: detect-changes
    if: needs.detect-changes.outputs.server == 'true' || needs.detect-changes.outputs.shared == 'true'
    runs-on: blacksmith-4vcpu-ubuntu-2404
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v3

      - name: Load cached venv
        id: cached-uv-dependencies
        uses: actions/cache@v4
        with:
          path: opennotes-server/.venv
          key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/uv.lock') }}

      - name: Install dependencies
        working-directory: opennotes-server
        run: |
          uv venv
          uv pip install -e .

      - name: Run schema consistency validation
        working-directory: opennotes-server
        env:
          JWT_SECRET_KEY: dGVzdC1qd3Qtc2VjcmV0LWtleS1mb3ItY2ktdGVzdGluZy1vbmx5LWRvLW5vdC11c2UtaW4tcHJvZHVjdGlvbg==
          CREDENTIALS_ENCRYPTION_KEY: cXRS8fmiHqGBVHwrX_9J7D4tHp_ZpFTMr3_XjP7kF1Y=
          ENCRYPTION_MASTER_KEY: R3pKvHGkdPxBc6FZ4N8qYmV2sJwLxTnC9A7M5E1bUh0=
        run: |
          echo "Running schema consistency validation..."
          uv run python scripts/check_schema_consistency.py
          echo "✅ Schema consistency validation passed"

  test-typescript:
    name: Test TypeScript (opennotes-discord)
    needs: detect-changes
    if: needs.detect-changes.outputs.discord == 'true' || needs.detect-changes.outputs.shared == 'true'
    runs-on: blacksmith-4vcpu-ubuntu-2404
    timeout-minutes: 20
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Build PostgreSQL with pgvector and pgroonga
        run: |
          docker build -t opennotes/postgres:18-pgvector-pgroonga docker/postgres
          echo "PostgreSQL image built with pgvector and pgroonga extensions"

      - name: Start PostgreSQL with pgvector and pgroonga
        run: |
          docker run -d --name postgres \
            -e POSTGRES_USER=opennotes \
            -e POSTGRES_PASSWORD=opennotes_password \
            -e POSTGRES_DB=opennotes_test \
            -p 5432:5432 \
            opennotes/postgres:18-pgvector-pgroonga
          # Wait for PostgreSQL to be ready
          timeout 60 bash -c 'until docker exec postgres pg_isready -U opennotes 2>/dev/null; do sleep 1; done'
          echo "PostgreSQL with pgvector and pgroonga is ready"

      - name: Start NATS with JetStream
        run: |
          docker run -d --name nats \
            -p 4222:4222 -p 8222:8222 \
            nats:2.10-alpine \
            --jetstream --http_port=8222
          timeout 30 bash -c 'until wget -q --spider http://localhost:8222/healthz 2>/dev/null; do sleep 1; done'
          echo "NATS with JetStream is ready"

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: opennotes-discord/pnpm-lock.yaml

      - name: Install dependencies
        working-directory: opennotes-discord
        run: pnpm install --frozen-lockfile

      - name: Clean and build workspace packages
        working-directory: opennotes-discord
        run: |
          pnpm --filter './packages/**' run clean || true
          pnpm --filter './packages/**' run build
          echo "Verifying dist files exist:"
          ls -la packages/shared-types/dist/ || echo "shared-types dist not found"
          ls -la packages/test-utils/dist/ || echo "test-utils dist not found"

      - name: Run tests with coverage
        working-directory: opennotes-discord
        env:
          DATABASE_URL: postgresql://opennotes:opennotes_password@localhost:5432/opennotes_test
          REDIS_URL: redis://localhost:6379
          NATS_URL: nats://localhost:4222
          NODE_ENV: test
        run: pnpm run test:ci

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: opennotes-discord/coverage/coverage-final.json
          flags: discord
          name: opennotes-discord

  security-scan-python:
    name: Security Scan Python
    needs: detect-changes
    if: needs.detect-changes.outputs.server == 'true' || needs.detect-changes.outputs.shared == 'true'
    runs-on: blacksmith-4vcpu-ubuntu-2404
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v3

      - name: Load cached venv
        id: cached-uv-dependencies
        uses: actions/cache@v4
        with:
          path: opennotes-server/.venv
          key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/uv.lock') }}

      - name: Install dependencies
        working-directory: opennotes-server
        run: |
          uv venv
          uv pip install -e ".[dev]"

      - name: Run bandit
        working-directory: opennotes-server
        run: uv run bandit -r src -f json -o bandit-report.json
        continue-on-error: true

      - name: Run safety check
        working-directory: opennotes-server
        run: uv run safety check --json
        continue-on-error: true

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports-python
          path: opennotes-server/bandit-report.json

  security-scan-typescript:
    name: Security Scan TypeScript
    needs: detect-changes
    if: needs.detect-changes.outputs.discord == 'true' || needs.detect-changes.outputs.shared == 'true'
    runs-on: blacksmith-4vcpu-ubuntu-2404
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: opennotes-discord/pnpm-lock.yaml

      - name: Install dependencies
        working-directory: opennotes-discord
        run: pnpm install --frozen-lockfile

      - name: Run pnpm audit
        working-directory: opennotes-discord
        run: pnpm audit --json > pnpm-audit.json
        continue-on-error: true

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports-typescript
          path: opennotes-discord/pnpm-audit.json

  validate-api-endpoints:
    name: Validate API Endpoints
    needs: detect-changes
    if: (needs.detect-changes.outputs.server == 'true' || needs.detect-changes.outputs.discord == 'true') || needs.detect-changes.outputs.shared == 'true'
    runs-on: blacksmith-4vcpu-ubuntu-2404
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v3

      - name: Load cached venv
        id: cached-uv-dependencies
        uses: actions/cache@v4
        with:
          path: opennotes-server/.venv
          key: venv-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('**/uv.lock') }}

      - name: Install dependencies
        working-directory: opennotes-server
        run: |
          uv venv
          uv pip install -e .

      - name: Generate OpenAPI specification
        working-directory: opennotes-server
        env:
          JWT_SECRET_KEY: test-jwt-secret-key-for-ci-pipeline-min-32-chars
          CREDENTIALS_ENCRYPTION_KEY: bEhsd3V1j2dPhxNfPdzHvVardNBKAsgXe4uz3v_XvEo=
          ENCRYPTION_MASTER_KEY: VifXZGGipg5_7Sqln37MC-coQxLJwNwdSNADRCGCiMM=
        run: uv run python scripts/generate-openapi.py --output openapi.json

      - name: Validate API endpoints
        run: python3 scripts/validate-api-endpoints.py

      - name: Upload OpenAPI spec
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: openapi-spec
          path: opennotes-server/openapi.json

  ci-success:
    name: CI Success
    needs: [pre-commit, lint-python, lint-typescript, unit-tests-python, integration-tests-python, test-typescript, validate-schema, validate-schema-consistency, security-scan-python, security-scan-typescript, validate-api-endpoints]
    if: always()
    runs-on: blacksmith-4vcpu-ubuntu-2404
    timeout-minutes: 15
    steps:
      - name: Check all jobs
        run: |
          if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" ]]; then
            echo "One or more CI jobs failed"
            exit 1
          fi
          if [[ "${{ contains(needs.*.result, 'cancelled') }}" == "true" ]]; then
            echo "One or more CI jobs were cancelled"
            exit 1
          fi
          echo "All CI jobs passed successfully"
